name: A workflow for deploy
on: 
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch name'
        required: true
      semver:
        description: 'Semantic Version (in format Major.Minor.Patch)'
        required: true

jobs:
  deploy:
    name: Deploy
    runs-on: windows-latest
    steps:
      - name: Set current artifact name
        id: current-artifact
        run: |
             echo "::set-output name=CURRENT_ARTIFACT::$(echo myartifact_${{ github.event.inputs.branch }}_${{ github.event.inputs.semver }})"
   
      - name: Retrieve artifact list
        id: artifact-list
        run: |
             # echo "::set-output name=ARTIFACT_LIST::$(curl -fs https://api.github.com/repos/${{github.repository}}/actions/artifacts)"
             (Invoke-WebRequest -Uri https://api.github.com/repos/${{github.repository}}/actions/artifacts).Content > artifact-list-file.json
             
      - name: Get latest artifact URL
        id: url
        run: |
             $myid = cat artifact-list-file.json | jq '[ .artifacts[] | select(.name == \"${{ steps.current-artifact.outputs.CURRENT_ARTIFACT }}\" and .expired == false) | .id ] | max' 
             $myurl = cat artifact-list-file.json | jq '.artifacts[] | select(.name == \"${{ steps.current-artifact.outputs.CURRENT_ARTIFACT }}\" and .id == $myid ) | .archive_download_url'
             echo ::set-output name=MAX_ID::$myid
             echo ::set-output name=URL::$myurl
      
      - run: echo "${{ steps.url.outputs.MAX_ID }}"
      - run: echo "${{ steps.url.outputs.URL }}"
